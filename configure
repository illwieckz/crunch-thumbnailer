#! /bin/sh

tab="$(printf '\t')"

cat > Makefile <<-EOF
.DEFAULT_GOAL := build
.PHONY: build install checkinstall uninstall

build:

install:
${tab}install -m +r,u+w src/crunch.thumbnailer /usr/share/thumbnailers/crunch.thumbnailer
${tab}install -m +rx,u+w src/crunch-thumbnailer /usr/bin/crunch-thumbnailer
EOF

if [ "x$(xdg-mime query filetype samples/sample.dds)" != 'ximage/x-dds' ]
then
	echo "image/x-dds mimetype file definition is missing, will install it"
	alias missingdds=true
else
	alias missingdds=false
fi

if [ "x$(xdg-mime query filetype samples/sample.crn)" != 'ximage/x-crn' ]
then
	echo "image/x-crn mimetype file definition is missing, will install it"
	alias missingcrn=true
else
	alias missingcrn=false
fi

if missingdds
then
	cat >> Makefile <<-EOF
	${tab}install -m +r,u+w src/crunch-dds-mime.xml /usr/share/mime/packages/crunch-dds-mime.xml
	EOF
fi

if missingcrn
then
	cat >> Makefile <<-EOF
	${tab}install -m +r,u+w src/crunch-crn-mime.xml /usr/share/mime/packages/crunch-crn-mime.xml
	EOF
fi

cat >> Makefile <<-EOF

checkinstall:
${tab}fakeroot checkinstall \
${tab}${tab}--fstrans=yes \
${tab}${tab}--install=no \
${tab}${tab}--pkgname="crunch-thumbnailer" \
${tab}${tab}--pkglicense="ISC" \
${tab}${tab}--pkgversion="0~\$(shell git log -1 --format=%at | xargs -I{} date -d '@{}' '+%Y%m%d-%H%M%S')~\$(shell git log --format="%H" -n 1 | cut -c1-7)" \
${tab}${tab}--pkgrelease="\$(shell date --utc '+%Y%m%d-%H%M%S')"
EOF

cat >> Makefile <<-EOF
uninstall:
${tab}rm /usr/share/thumbnailers/crunch.thumbnailer
${tab}rm /usr/bin/crunch-thumbnailer
EOF

if missingdds
then
	cat >> Makefile <<-EOF
	${tab}rm /usr/share/mime/packages/crunch-dds-mime.xml
	EOF
fi

if missingcrn
then
	cat >> Makefile <<-EOF
	${tab}rm /usr/share/mime/packages/crunch-crn-mime.xml
	EOF
fi

cat >> Makefile <<EOF

update-db:
${tab}update-mime-database /usr/share/mime
EOF

#EOF
